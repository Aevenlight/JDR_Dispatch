<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dispatch JDR</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<main class="app">

  <!-- ===================== -->
  <!-- PANNEAU GAUCHE -->
  <!-- ===================== -->
  <section class="panel panel-left">

    <header class="panel-header">
      <h1 class="title">Dispatch JDR</h1>
      <p class="subtitle">Test de compétence</p>
    </header>

    <!-- ===== Sélecteur de personnage ===== -->
    <div class="group">
      <h2 class="group-title">Personnage</h2>

      <div class="id-card">
        <img id="portrait" class="portrait" src="" alt="Portrait personnage" />
        <div class="id-info">
          <div id="charName" class="char-name">—</div>
          <select id="characterSelect" class="char-select"></select>
        </div>
      </div>
    </div>

    <!-- ===== Stats requises (sliders conservés) ===== -->
    <div class="group">
      <h2 class="group-title">Stats requises</h2>
      <div id="reqControls" class="controls"></div>
    </div>

    <!-- ===== Actions ===== -->
    <div class="actions">
      <button id="rollBtn" class="btn">Lancer</button>
      <div id="result" class="result">—</div>
    </div>

  </section>

  <!-- ===================== -->
  <!-- PANNEAU DROIT -->
  <!-- ===================== -->
  <section class="panel panel-right">

    <header class="panel-header">
      <h2 class="group-title">Résolution</h2>
    </header>

    <div class="canvas-wrap">
      <canvas id="c" width="760" height="520"></canvas>
    </div>

  </section>

</main>

<script>
(() => {

  /* =====================================================
     CONFIG
  ===================================================== */

  const STATS = ["Force","Vigueur","Mobilité","Charisme","Intelligence"];
  const MAX_STAT = 10;

  const ICONS = {
    Force: "icons/Force.png",
    Vigueur: "icons/Vigueur.png",
    Mobilité: "icons/Mobilité.png",
    Charisme: "icons/Charisme.png",
    Intelligence: "icons/Intelligence.png",
  };

  const CHARACTER_FILES = [
    "personnages/perso_01.json",
    "personnages/perso_02.json",
    "personnages/perso_03.json"
  ];

  /* =====================================================
     COULEURS / SIMU
  ===================================================== */

  const COL = {
    panelBg: "#fff0d9",
    pentFill: "#322a1f",
    grid: "#615a43",

    charFill: "rgba(255,199,58,0.40)",
    charStroke: "rgba(255,199,58,1)",

    reqFill: "rgba(255,255,249,0.40)",
    reqStroke: "rgba(255,255,249,1)",

    puckRolling: "#000000",
    puckSuccess: "#6dc383",
    puckFail: "#f98277"
  };

  const MIN_DURATION = 7.0;
  const MAX_DURATION = 9.0;
  const START_SPEED = 360;
  const FRICTION = 0.992;
  const STOP_SPEED = 18;
  const MAX_BOUNCES = 40;

  /* =====================================================
     ETAT
  ===================================================== */

  const char = { Force:0, Vigueur:0, Mobilité:0, Charisme:0, Intelligence:0 };
  const req  = { Force:2, Vigueur:2, Mobilité:5, Charisme:5, Intelligence:2 };

  let characters = [];
  let currentCharacter = null;

  /* =====================================================
     UI ELEMENTS
  ===================================================== */

  const portraitImg = document.getElementById("portrait");
  const charNameEl  = document.getElementById("charName");
  const selectEl    = document.getElementById("characterSelect");
  const reqControls = document.getElementById("reqControls");
  const rollBtn     = document.getElementById("rollBtn");
  const resultEl    = document.getElementById("result");

  /* =====================================================
     BUILD REQ SLIDERS
  ===================================================== */

  function mkSlider(container, obj, key) {
    const row = document.createElement("div");
    row.className = "row";

    const label = document.createElement("label");
    label.className = "lbl";
    label.textContent = key;

    const val = document.createElement("div");
    val.className = "val";
    val.textContent = obj[key];

    const rng = document.createElement("input");
    rng.className = "rng";
    rng.type = "range";
    rng.min = 0;
    rng.max = MAX_STAT;
    rng.value = obj[key];

    rng.addEventListener("input", () => {
      obj[key] = Number(rng.value);
      val.textContent = obj[key];
      draw();
    });

    row.append(label, val);
    container.append(row, rng);
  }

  STATS.forEach(k => mkSlider(reqControls, req, k));

  /* =====================================================
     LOAD CHARACTERS
  ===================================================== */

  async function loadCharacters() {
    const data = await Promise.all(
      CHARACTER_FILES.map(f => fetch(f).then(r => r.json()))
    );

    characters = data;
    selectEl.innerHTML = "";

    data.forEach((c, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = c.nom;
      selectEl.appendChild(opt);
    });

    selectCharacter(0);
  }

  function selectCharacter(index) {
    const c = characters[index];
    currentCharacter = c;

    Object.assign(char, c.stats);

    portraitImg.src = c.portrait;
    charNameEl.textContent = c.nom;

    draw();
  }

  selectEl.addEventListener("change", e => {
    selectCharacter(e.target.value);
  });

  /* =====================================================
     CANVAS / MOTEUR
  ===================================================== */

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const cx = canvas.width * 0.55;
  const cy = canvas.height * 0.52;
  const R  = Math.min(canvas.width, canvas.height) * 0.38;

  function deg(a){ return a * Math.PI / 180; }

  function polyFromStats(obj){
    return STATS.map((k,i)=>{
      const a = deg(-90 + i * 72);
      const r = (obj[k] / MAX_STAT) * R;
      return { x: cx + Math.cos(a)*r, y: cy + Math.sin(a)*r };
    });
  }

  function pointInPoly(p, poly){
    let inside = false;
    for(let i=0,j=poly.length-1;i<poly.length;j=i++){
      const a = poly[i], b = poly[j];
      if(((a.y>p.y)!=(b.y>p.y)) &&
        p.x < (b.x-a.x)*(p.y-a.y)/(b.y-a.y)+a.x){
        inside = !inside;
      }
    }
    return inside;
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // fond fenêtre
    ctx.fillStyle = COL.panelBg;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const outer = polyFromStats({
      Force:10,Vigueur:10,Mobilité:10,Charisme:10,Intelligence:10
    });

    // fond pentagone
    ctx.beginPath();
    outer.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
    ctx.closePath();
    ctx.fillStyle = COL.pentFill;
    ctx.fill();

    // grille
    ctx.strokeStyle = COL.grid;
    ctx.lineWidth = 1;
    for(let k=2;k<=10;k+=2){
      const r = (k/10)*R;
      ctx.beginPath();
      STATS.forEach((_,i)=>{
        const a = deg(-90+i*72);
        const x = cx+Math.cos(a)*r;
        const y = cy+Math.sin(a)*r;
        i?ctx.lineTo(x,y):ctx.moveTo(x,y);
      });
      ctx.closePath();
      ctx.stroke();
    }

    // polygones
    const reqPoly  = polyFromStats(req);
    const charPoly = polyFromStats(char);

    drawPoly(reqPoly, COL.reqFill, COL.reqStroke, 2);
    drawPoly(charPoly, COL.charFill, COL.charStroke, 2.5);
  }

  function drawPoly(pts, fill, stroke, w){
    ctx.beginPath();
    pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
    ctx.closePath();
    ctx.fillStyle = fill;
    ctx.fill();
    ctx.lineWidth = w;
    ctx.strokeStyle = stroke;
    ctx.stroke();
  }

  /* =====================================================
     INIT
  ===================================================== */

  loadCharacters();
  draw();

})();
</script>

</body>
</html>
